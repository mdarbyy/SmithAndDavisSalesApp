<style>
  .main-content-row {
    height: 100dvh;
    display: flex;
    overflow-y: auto;
    scrollbar-width: none;
  }

  .left-col,
  .right-col,
  .dashboard-content {
    display: flex;
    flex-direction: column;
    min-height: 0;
  }

  #sales-chart {
    flex-grow: 1;               
    min-height: 0;
  }

  #selectDateRange {
    min-height: calc(100dvh - 180px);
    display: flex;
    justify-content: center;
    align-items: center;
  }
</style>

<% if @start_date.blank? || @end_date.blank? %>
  <div class="d-flex justify-content-center align-items-center" id="selectDateRange">
    <div class="card p-4" style="max-width: 380px; width: 100%;">
      <h4 class="mb-3 text-center">Select a date range</h4>
      <%= form_with url: dashboard_path, method: :get, local: true do |form| %>
        <div class="mb-3">
          <%= form.label :start_date, "Start Date", class: "form-label" %>
          <div class="input-group">
            <%= form.text_field :start_date, class: "form-control datepicker", required: true, value: (params[:start_date].presence || Date.current.strftime("%m/%d/%Y")) %>
            <span class="input-group-text datepicker-icon">
              <i class="bi bi-calendar3"></i>
            </span>
          </div>
        </div>

        <div class="mb-3">
          <%= form.label :end_date, "End Date", class: "form-label" %>
          <div class="input-group">
            <%= form.text_field :end_date, class: "form-control datepicker", required: true, value: (params[:end_date].presence || Date.current.strftime("%m/%d/%Y")) %>
            <span class="input-group-text datepicker-icon">
              <i class="bi bi-calendar3"></i>
            </span>
          </div>
        </div>

        <div class="d-flex justify-content-end">
          <%= form.submit "View Dashboard", class: "btn btn-main", data: { turbo: false }, onclick:"show_spinner()" %>
        </div>
      <% end %>
    </div>
  </div>
<% else %>
  <div class="modal fade" id="totalSalesModal" tabindex="-1" aria-labelledby="totalSalesModalLabel" aria-hidden="true">
    <div class="modal-dialog custom-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="totalSalesModalLabel"><b><span id="salesPersonName"></span></b></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="scrollable-table show-scrollbar">
            <table class="table content" id="totalSalesModalTable">
              <thead>
                <tr>
                  <th class="stick" scope="col">Sell Date</th>
                  <th class="stick" scope="col">Amount Sold</th>
                  <th class="stick" scope="col" style="min-width: 120px;">Sales Floor Hours</th>
                  <th class="stick" scope="col" style="min-width: 120px;">Average Per Hour</th>
                  <th class="stick" scope="col">Project Hours</th>
                </tr>
              </thead>
              <tbody id="totalSalesModalTableBody">
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container-fluid">
    <div class="row main-content-row">
      <div class="col-12 col-md-3 left-col">
        <div class="card mb-3 p-4">
          <h5 class="text-center mb-3">Change the date range</h5>
          <%= form_with url: dashboard_path, method: :get, local: true do |form| %>
            
            <div class="mb-3">
              <%= form.label :start_date, "Start Date", class: "form-label" %>
              <div class="input-group">
                <%= form.text_field :start_date, class: "form-control datepicker", required: true, value: (params[:start_date].presence || Date.current.strftime("%m/%d/%Y")) %>
                <span class="input-group-text datepicker-icon">
                  <i class="bi bi-calendar3"></i>
                </span>
              </div>
            </div>

            <div class="mb-3">
              <%= form.label :end_date, "End Date", class: "form-label" %>
              <div class="input-group">
                <%= form.text_field :end_date, class: "form-control datepicker", required: true, value: (params[:end_date].presence || Date.current.strftime("%m/%d/%Y")) %>
                <span class="input-group-text datepicker-icon">
                  <i class="bi bi-calendar3"></i>
                </span>
              </div>
            </div>

            <div class="d-flex justify-content-end">
              <%= form.submit "Submit", class: "btn btn-main", data: { turbo: false }, onclick:"show_spinner()" %>
            </div>
          <% end %>
        </div>

        <div class="card p-4" id="filterCard">
          <h5 class="mb-2 text-center" id="filterHeader">Filters</h5>
          
          <div class="mb-3 d-flex flex-column align-items-center">
            <select id="sales-person-filter"
              class="selectpicker btn-secondary filter-select"
              multiple
              data-actions-box="true"
              title="Sales People"
              data-selected-text-format="count"
              data-count-selected-text="{0} people selected"
              data-width="100%">
            </select>
          </div>
          
          <div class="d-flex flex-column align-items-center">
            <select id="sell-date-filter"
              class="selectpicker btn-secondary filter-select"
              multiple
              data-actions-box="true"
              title="Sell Date"
              data-selected-text-format="count"
              data-count-selected-text="{0} dates selected"
              data-width="100%">
            </select>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-9 right-col">
        <div class="card dashboard-content">
          <div class="card-body" id="dashboardTabsContent">
            <div class="mb-1 d-flex justify-content-end">
              <button id="export-sales-chart" class="btn btn-main">Export to Excel</button>
            </div>
            <div id="sales-chart"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
<% end %>

<% if @start_date.present? and @end_date.present? %>
  <script>
    $(document).ready(function() {

      function updateFilterSection() {
        const card = document.getElementById("filterCard");
        const selects = document.querySelectorAll('.filter-select');
        const screenHeight = window.innerHeight;

        selects.forEach(select => {
          select.setAttribute('data-dropup-auto', 'false');

          // Save desired direction into dataset for later
          if (screenHeight <= 900) {
            select.classList.add('dropup');
          } else {
            select.classList.remove('dropup');
            select.dataset.forceDirection = 'down';
          }
        });
      }

      $(document).on('show.bs.select', '.filter-select', function () {
        const wrapper = $(this).closest('.bootstrap-select');
        const direction = this.dataset.forceDirection;
        if(direction === 'down'){
          wrapper.removeClass('dropup').addClass('dropdown');
        }
      });

      window.addEventListener('resize', updateFilterSection);

      updateFilterSection();

      console.log("Height: " + window.innerHeight);

      const mainColor = getComputedStyle(document.documentElement)
      .getPropertyValue('--main-color')
      .trim();

      const avgColor = getComputedStyle(document.documentElement)
      .getPropertyValue('--bargraph-avg-color')
      .trim();

      const hourColor = getComputedStyle(document.documentElement)
      .getPropertyValue('--bargraph-hour-color')
      .trim();

      const salesRecords = <%= raw @sales_records.to_json %>;
      const salesPeople = <%= raw @sales_people.to_json %>;
      const salesPeopleWithoutSales = <%= raw @sales_people_without_sales.to_json %>;

      salesPeopleWithoutSales.sort((a, b) => {
        const nameA = `${a.first_name} ${a.last_name}`.toLowerCase();
        const nameB = `${b.first_name} ${b.last_name}`.toLowerCase();
        if (nameA < nameB) return -1;
        if (nameA > nameB) return 1;
        return 0;
      });

    	console.log("Sales Records:", salesRecords);
    	console.log("Sales People:", salesPeople);
      console.log("Sales People Without Sales: " + salesPeopleWithoutSales);

    	const salesPersonIdToName = {};
    	salesPeople.forEach(sp => {
    		const name = `${sp.first_name} ${sp.last_name}`.trim().replace(/\s+/g, ' ');
    		salesPersonIdToName[sp.id] = name;
    	});

      salesPeopleWithoutSales.forEach(sp => {
        const name = `${sp.first_name} ${sp.last_name}`.trim().replace(/\s+/g, ' ');
    		salesPersonIdToName[sp.id] = name;
      });

      function addPadding(row){
        row.style.paddingTop = "10px";
        row.style.paddingBottom = "10px";
        return row;
      }

      function formatNumber(value) {
        if (value % 1 === 0) {
          return value.toLocaleString();
        }
        return value.toLocaleString(undefined, {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
      }

      function getFilteredSalesRecords() {
        const selectedSalesPersonIds = $('#sales-person-filter').val() || [];
        const selectedSellDates = $('#sell-date-filter').val() || [];

        const filteredRecords = salesRecords.filter(record =>
          selectedSalesPersonIds.includes(String(record.sales_person_id)) &&
          selectedSellDates.includes(record.sell_date)
        );

        return filteredRecords;
      }

      function populateSalesPersonSelect() {
        let select = $('#sales-person-filter');
        select.find('option').remove();

        const optionsHtml = Object.entries(salesPersonIdToName)
        .sort((a, b) => a[1].localeCompare(b[1]))
        .map(([id, name]) => new Option(name, id, true, true).outerHTML)
        .join('');

        select.html(optionsHtml);
        select.selectpicker('destroy');
        select.selectpicker();

        select.off('changed.bs.select').on('changed.bs.select', function () {
          populateSellDateSelect();
          processSalesRecords();
        });
      }

      function populateSellDateSelect() {
        const select = $('#sell-date-filter');
        select.find('option').remove();

        var selectedSalesPersonIds = $('#sales-person-filter').val() || [];
        
        var filteredSalesRecords = salesRecords.filter(record =>
          selectedSalesPersonIds.includes(String(record.sales_person_id))
        );
        
        const uniqueDates = [...new Set(filteredSalesRecords.map(r => r.sell_date))].sort();

        const optionsHtml = uniqueDates.map(dateStr => {
          const formattedDate = luxon.DateTime.fromISO(dateStr).toFormat('MM/dd/yyyy');
          return new Option(formattedDate, dateStr, true, true).outerHTML;
        }).join('');

        select.html(optionsHtml);
        select.selectpicker('destroy');
        select.selectpicker();

        select.off('changed.bs.select').on('changed.bs.select', function () {
          processSalesRecords();
        });
      }

      function processSalesRecords(){
        const round2 = n =>
        Math.round((Number(n) + Number.EPSILON) * 100) / 100;
        
        //look at the selectors and get records for the selected sales people and sell dates
        const filteredRecords = getFilteredSalesRecords();
        
        //define the object to store the data for the graph and excel file
        const totalsByPerson = {};
        const grandTotals = {
          amountSold: 0,
          salesFloorHours: 0,
          projectHours: 0,
          avgPerHour: 0
        };

        /*
          1. loop over each record from the filters and define an object for each sales person if they do not exist

          2. get the amount sold, sales floor hours, and project hours stored in the record. inside
          the object there is a records array. create a object in the records array for that sell date
          and store the values.

          3. add the amount sold, sales floor hours, and project hours to that sales persons totals as well as the grand total 
        */

        filteredRecords.forEach(record => {
          const personId = record.sales_person_id;
          const personName = salesPersonIdToName[personId];
          const sellDate = record.sell_date;

          if (!totalsByPerson[personId]) totalsByPerson[personId] = { name: personName,
          records: {},
            totals: {
              amountSold: 0,
              salesFloorHours: 0,
              projectHours: 0
            },
            avgPerHour: 0
          };

          const amountSold = Number(record.amount_sold);
          const salesFloorHours = round2(record.sales_floor_hours);
          const projectHours = round2(record.project_hours);

          totalsByPerson[personId].records[sellDate] = {
            amountSold,
            salesFloorHours,
            projectHours
          };

          totalsByPerson[personId].totals.amountSold += amountSold;
          totalsByPerson[personId].totals.salesFloorHours += salesFloorHours;
          totalsByPerson[personId].totals.projectHours += projectHours;

          grandTotals.amountSold += amountSold;
          grandTotals.salesFloorHours += salesFloorHours;
          grandTotals.projectHours += projectHours;
        });

        /*
          4. add in the active sales people who did not sell anything so they show up on the graph
        */

        const selectedSalesPersonIds = $('#sales-person-filter').val() || [];

        salesPeopleWithoutSales.forEach(sp =>{
          if(selectedSalesPersonIds.includes(String(sp.id))){
            if (!totalsByPerson[sp.id]) totalsByPerson[sp.id] = { name: sp.first_name + " " + sp.last_name,
            records: {},
              totals: {
                amountSold: 0,
                salesFloorHours: 0,
                projectHours: 0
              },
              avgPerHour: 0
            };
          }
        });

        /* 
          5. after looping over the records loop over each person in the totalsByPerson object and calculate their average 
        */

        Object.values(totalsByPerson).forEach(person => {
          const totals = person.totals;
          person.avgPerHour =
            totals.salesFloorHours > 0
              ? Number((totals.amountSold / totals.salesFloorHours).toFixed(2))
              : 0;
        });

        /*
          6. calculate the grand total average per hour by dividing the grand total amount sold by the grand total sales floor hours 
        */

        grandTotals.avgPerHour = grandTotals.salesFloorHours > 0
        ? Number((grandTotals.amountSold / grandTotals.salesFloorHours).toFixed(2))
        : 0;

        /* 
          7. with each persons average calculated created the filteredData by mapping the values needed for the bar graph and create the Highcharts bar graph
        */
        
        console.log("Totals by Person:", totalsByPerson);
        console.log("Grand Totals:", grandTotals);

        const filteredData = Object.values(totalsByPerson).map(p => ({
          name: p.name,
          totalSales: p.totals.amountSold,
          totalSalesHours: p.totals.salesFloorHours,
          totalProjectHours: p.totals.projectHours,
          avgPerHour: p.avgPerHour,
          hasRecords: p.records && Object.keys(p.records).length > 0
        })).sort((a, b) => {
          
          // total sales
          if (b.totalSales !== a.totalSales) {
            return b.totalSales - a.totalSales;
          }

          // has records (true first)
          if (a.hasRecords !== b.hasRecords) {
            return b.hasRecords - a.hasRecords;
          }

          // name (ascending)
          return a.name.localeCompare(b.name);
        });

        const categories = filteredData.map(p => p.name);
        const data = filteredData.map(p => ({
          y: p.totalSales,
          custom: {
            sales_hours: p.totalSalesHours,
            project_hours: p.totalProjectHours,
            avg: p.avgPerHour,
            hasRecords: p.hasRecords
          }
        }));

        //function to show modal with a sales persons records when clicking on a bar on the graph
        function showSalesForClickedPerson(clickedName){
          const salesPersonId = Object.keys(salesPersonIdToName).find(
            id => salesPersonIdToName[id] === clickedName
          );

          const personData = totalsByPerson[salesPersonId];
          if (!personData) return;

          //return if this person has no records
          if (Object.keys(personData.records).length === 0) return;

          const recordsByDate = personData.records;
          const tbody = document.querySelector('#totalSalesModalTableBody');
          tbody.innerHTML = '';

          document.getElementById('salesPersonName').textContent = clickedName;

          const sortedRecords = Object.entries(personData.records)
          .sort(([dateA], [dateB]) => new Date(dateA) - new Date(dateB));

          sortedRecords.forEach(([isoDate, record]) => {
            const formattedDate = luxon.DateTime.fromISO(isoDate).toFormat('MM/dd/yyyy');
            const dailyTotal = record.amountSold;
            const dailySalesHours = record.salesFloorHours;
            const dailyProjectHours = record.projectHours;
            const dailyAvgRaw = dailySalesHours > 0 && dailyTotal > 0
            ? (dailyTotal / dailySalesHours)
            : 0;

            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${formattedDate}</td>
              <td>$${formatNumber(dailyTotal)}</td>
              <td>${dailySalesHours.toLocaleString()}</td>
              <td>$${formatNumber(dailyAvgRaw)}</td>
              <td>${dailyProjectHours.toLocaleString()}</td>
            `;
            tbody.appendChild(row);
          });

          // Only show totals if more than one unique date
          if (sortedRecords.length > 1) {
            const overallAvg = personData.totals.salesFloorHours > 0 ? (personData.totals.amountSold / personData.totals.salesFloorHours).toFixed(2) : 0;

            let spaceRowBefore = document.createElement('tr');
            spaceRowBefore.innerHTML = `
            <td colspan="6"></td>
            `;
            tbody.appendChild(spaceRowBefore);

            const totalRow = document.createElement('tr');
            totalRow.innerHTML = `
              <td><strong>Total</strong></td>
              <td><strong>$${formatNumber(personData.totals.amountSold)}</strong></td>
              <td><strong>${personData.totals.salesFloorHours.toLocaleString()}</strong></td>
              <td><strong>$${formatNumber(personData.avgPerHour)}</strong></td>
              <td><strong>${personData.totals.projectHours.toLocaleString()}</strong></td>
            `;
            tbody.appendChild(totalRow);
            addPadding(totalRow);

            let spaceRowAfter = document.createElement('tr');
            spaceRowAfter.innerHTML = `
            <td colspan="6"></td>
            `;
            tbody.appendChild(spaceRowAfter);
          }

          const modal = new bootstrap.Modal(document.getElementById('totalSalesModal'));
          modal.show();
        }

        Highcharts.chart('sales-chart', {
          chart: {
            type: 'column',
            marginTop: 150,
            scrollablePlotArea: {
              minWidth: categories.length * 100,
              scrollPositionX: 0
            }
          },
          title: {
            useHTML: true,
            text:
            `<div style="text-align: center;">
              <div style="font-size: 22px;">
                <% if @start_date == @end_date %>
                  Sales for <%= @start_date.strftime("%m/%d/%Y") %>
                <% else %>
                  Sales from <%= @start_date.strftime("%m/%d/%Y") %> to <%= @end_date.strftime("%m/%d/%Y") %>
                <% end %>
              </div>
            </div>
            `
          },
          subtitle: {
            useHTML: true,
            text: `
              <div style="text-align: center;">
                <div style="font-size: 18px; font-weight: bold; color: #333;">
                  $${formatNumber(grandTotals.amountSold)}
                </div>
                ${grandTotals.avgPerHour > 0 ? `
                  <div style="font-size: 14px; font-weight: bold; color: ${avgColor};">
                    $${formatNumber(grandTotals.avgPerHour)}/hr
                  </div>
                ` : `<div style="font-size: 14px; font-weight: bold; color: ${avgColor};">
                    $0/hr
                  </div>`
                  }
              </div>
            `
          },
          xAxis: {
            categories: categories,
            title: { text: 'Sales People' },
          },
          yAxis: {
            min: 0,
            title: { text: 'Sales ($)' }
          },
          tooltip: {
            enabled: false
          },
          plotOptions: {
            column: {
              cursor: 'pointer',
              point: {
                events: {
                  click: function() {
                    showSalesForClickedPerson(this.category);
                  }
                }
              },
              dataLabels: {
              enabled: true,
              inside: false,
              crop: false,
              overflow: 'none',
              useHTML: true,
              formatter: function() {
                const sales = '$' + formatNumber(this.y);
                const sales_hours = this.point.custom?.sales_hours || 0;
                const project_hours = this.point.custom?.project_hours || 0;
                const avg = this.point.custom?.avg || 0;
                const hasRecords = this.point.custom?.hasRecords;

                let labelString = '';
                if(hasRecords){
                  const hourlyRate =
                  avg > 0 ? `$${formatNumber(avg)}/hr` : `$0/hr`;
                  const salesHours = sales_hours == 1 ? `${sales_hours} hour` : `${sales_hours} hours`;

                  labelString = `
                    <div style="text-align: center;">
                      <div>${sales}</div>
                      <div style="font-size: 12px; color: ${hourColor};">${salesHours}</div>
                      <div style="font-size: 12px; color: ${avgColor};">
                        ${hourlyRate}
                      </div>
                    </div>
                  `;
                } else {
                  labelString = `
                    <div style="text-align: center;">
                      <div>---</div>
                    </div>
                  `;
                }
                
                return labelString;
                },
                style: {
                  color: '#333',
                  fontSize: '14px'
                }
              }
            }
          },
          series: [{
            name: 'Sales',
            data: data,
            color: mainColor
          }],
          credits: {
            enabled: false
          }
        });

        //when the export to excel button is clicked
        $('#export-sales-chart').off('click').on('click', async () => {
          const startDate = "<%= @start_date.strftime('%m/%d/%Y') %>";
          const endDate = "<%= @end_date.strftime('%m/%d/%Y') %>";

          // --- Sort by total amount sold (descending)
          const sortedBySales = Object.values(totalsByPerson)
          .sort((a, b) => b.totals.amountSold - a.totals.amountSold);

          // --- Sort by avgPerHour (descending)
          const sortedByAvg = Object.values(totalsByPerson)
          .sort((a, b) => b.avgPerHour - a.avgPerHour);

          // --- Build workbook
          const wb = new ExcelJS.Workbook();
          const ws = wb.addWorksheet('Sales Report', {
            pageSetup: {
              orientation: 'landscape',
              margins: {
                left: 0.25,
                right: 0.25,
                top: 0.50,
                bottom: 0.50,
                header: 0.3,
                footer: 0.3
              },
              fitToWidth: 1,
              fitToHeight: 0,
              showGridLines: true 
            }
          });

          // --- Title (row 1)
          ws.mergeCells('A1:H1');
          const titleCell = ws.getCell('A1');
          titleCell.value = startDate === endDate
            ? `Sales for ${startDate}`
            : `Sales from ${startDate} to ${endDate}`;
          titleCell.font = { bold: true, size: 14 };
          titleCell.alignment = { horizontal: 'center', vertical: 'middle' };

          let fileName = startDate === endDate
            ? `Sales-Report-for-${startDate.replace(/\//g, '-')}.xlsx`
            : `Sales-Report-from-${startDate.replace(/\//g, '-')}-to-${endDate.replace(/\//g, '-')}.xlsx`;

          // --- Row 2: Total amount
          ws.mergeCells('A2:H2');
          const totalAmountCell = ws.getCell('A2');
          totalAmountCell.value = `Amount Sold: $${formatNumber(grandTotals.amountSold)}`
          totalAmountCell.font = { size: 12 };
          totalAmountCell.alignment = { horizontal: 'center', vertical: 'middle' };

          // --- Row 3: Average Per Hour
          ws.mergeCells('A3:H3');
          const avgCell = ws.getCell('A3');
          avgCell.value = `Average Per Hour: $${formatNumber(grandTotals.avgPerHour)}`;
          avgCell.font = { size: 12 };
          avgCell.alignment = { horizontal: 'center', vertical: 'middle' };

          // --- Spacer (row 4)
          ws.mergeCells('A4:H4');

          // --- Header (row 5)
          const headerRow = ws.addRow([
            'Rank',
            'Name',
            'Amount Sold',
            'Sales Floor Hours',
            'Project Hours',
            'Rank',
            'Name',
            'Average Per Hour'
          ]);
          headerRow.font = { bold: true };
          headerRow.alignment = { horizontal: 'center', vertical: 'middle' };
          headerRow.getCell(1).font = { bold: true, color: { argb: 'FFA8504B' } };
          headerRow.getCell(6).font = { bold: true, color: { argb: 'FFA8504B' } };

          /* 
            loop over the data that is sorted by the amount sold and fill out the excel file
            style the Rank columns to be the red color
          */

          let rank = 1;
          sortedBySales.forEach(personData => {
            const { name, totals, records } = personData;
            
            if(records && Object.keys(records).length > 0){
              const amountSold = totals.amountSold > 0 ? '$' + formatNumber(totals.amountSold) : '$0';
            
              const row = ws.addRow([
                rank,
                name,
                amountSold,
                totals.salesFloorHours,
                totals.projectHours,
                rank,
                null,
                null
              ]);

              row.getCell(1).font = { bold: true, color: { argb: 'FFA8504B' } };
              row.getCell(6).font = { bold: true, color: { argb: 'FFA8504B' } };
              row.alignment = { horizontal: 'center', vertical: 'middle' };

              rank++;
            }
          });

          /*
            filter the sales people to show ones with sales records only
            
            loop over the data that is sorted by the highest average and enter those into columns G and H
          */

          const withRecords = sortedByAvg.filter(
            p => p.records && Object.keys(p.records).length > 0
          );

          withRecords.forEach((p, i) => {
            const rowIndex = i + 6;
            const avgVal = p.avgPerHour;

            ws.getCell(rowIndex, 7).value = p.name;
            if(avgVal > 0){
              ws.getCell(rowIndex, 8).value = `$${formatNumber(avgVal)}`;
            } else {
              ws.getCell(rowIndex, 8).value = `$0`;
            }

            ws.getCell(rowIndex, 7).alignment = { horizontal: 'center', vertical: 'middle' };
            ws.getCell(rowIndex, 8).alignment = { horizontal: 'center', vertical: 'middle' };
          });

          /*
            lastly, take the sales people who are active employees that have not sold anything and enter them into the excel file alphabetically
          */

          salesPeopleWithoutSales.forEach(person => {
            const row = ws.addRow([
              rank,
              `${person.first_name} ${person.last_name}`,
              '---',
              '---',
              '---',
              rank,
              `${person.first_name} ${person.last_name}`,
              '---',
            ]);

            // Center align all cells
            [1,2,3,4,5,6,7,8].forEach(c => {
              row.getCell(c).alignment = { horizontal: 'center', vertical: 'middle' };
            });

            // Style Rank cell (A & F)
            row.getCell(1).font = { bold: true, color: { argb: 'FFA8504B' } };
            row.getCell(6).font = { bold: true, color: { argb: 'FFA8504B' } };

            rank++; // increment rank for next row
          });
          
          const widths = [10, 25, 20, 20, 20, 10, 25, 20];
          widths.forEach((w, i) => (ws.getColumn(i + 1).width = w));

          const buf = await wb.xlsx.writeBuffer();
          saveAs(new Blob([buf], { type: 'application/octet-stream' }), fileName);
        });
      }

      populateSalesPersonSelect();
      populateSellDateSelect();

      $('#sales-person-filter').on('changed.bs.select', function (e) {
        populateSellDateSelect();
        processSalesRecords();
      });

      $('#sell-date-filter').on('changed.bs.select', processSalesRecords);

      processSalesRecords();
    });
  </script>
<% end %>