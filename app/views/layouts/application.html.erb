<!DOCTYPE html>
<html>
  <head>
    <title>Smith & Davis Sales App</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="turbo-prefetch" content="false">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= favicon_link_tag 'favicon.png', rel: 'icon', type: 'image/png', sizes: '96x96' %>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Quicksand">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Handjet">

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    >

    <!-- Bootstrap Select CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css"
    >

    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <!-- Bootstrap Datepicker CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.10.0/dist/css/bootstrap-datepicker.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />

    <!-- jQuery (must load first for Bootstrap & Bootstrap Select) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <!-- Popper (needed by Bootstrap) -->
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
      crossorigin="anonymous"
    ></script>

    <!-- Bootstrap JS Bundle (includes Bootstrap's JS but NOT jQuery) -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
      integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
      crossorigin="anonymous"
    ></script>

    <!-- Bootstrap Select JS (must load after jQuery & Bootstrap JS) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>

    <!-- Select2 js -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <!-- Bootstrap Datepicker JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.10.0/dist/js/bootstrap-datepicker.min.js"></script>

    <!-- Luxon -->
    <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>

    <!-- Highcharts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/12.3.0/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>

    <!-- Excel -->
    <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <%= javascript_importmap_tags %>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
  </head>

  <body>
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" id="deleteModalDialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitle"></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <p id="delete-modal-message"></p>
            <button class="btn btn-delete float-end" id="modalDeleteConfirmButton">
              Delete
            </button>
          </div>

        </div>
      </div>
    </div>

    <div id="alertContainer"></div>
    <div id="overlay">
      <div style="margin-left: 110px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
        <div class="spinner-border" id="spinner" role="status"></div>
      </div>
    </div>
    
    <% if user_signed_in? %>
      <div class="d-flex flex-column authenticated">
        <div class="container-fluid d-flex flex-row p-0 flex-grow-1">
          <div class="position-relative d-flex flex-column" id="nav-sidebar">
            
            <div class="row">
              <div class="col">
                <h4 class="text-center">
                  <%= image_tag 'logo.png', class: "logo" %>
                </h4>
              </div>
            </div>
            
            <div class="row flex-grow-1 align-items-center">
              <div class="col">
                <ul class="list-group list-group-flush">
                  <li class="list-group-item">
                    <%= link_to "Dashboard", dashboard_path, class: "dashboard-link sidebar-nav-link #{'active' if current_page?(dashboard_path) or current_page?(root_path)}" %>
                  </li>
                  <li class="list-group-item">
                    <%= link_to "Sales People", sales_people_path, class: "dashboard-link sidebar-nav-link #{'active' if current_page?(sales_people_path)}" %>
                  </li>
                  <li class="list-group-item">
                    <%= link_to "Sales Records", sales_records_path, class: "dashboard-link sidebar-nav-link #{'active' if current_page?(sales_records_path)}" %>
                  </li>
                  <li class="list-group-item">
                    <%= link_to "Users", users_path, class: "dashboard-link sidebar-nav-link #{'active' if current_page?(users_path)}" %>
                  </li>
                </ul>
              </div>
            </div>  
          </div>

          <div class="main-content flex-grow-1 d-flex flex-column">
            <div class="navbar navbar-expand-lg fixed-top" id="nav-header">
              <div class="container-fluid">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                  <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                  <ul class="navbar-nav ms-auto mb-2 mb-lg-0"> 
                    <li class="nav-item dropdown">
                      <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" style="font-size: 18px;">
                        <%= current_user.first_name %> <%= current_user.last_name %>
                      </a>
                      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown"> 
                        <li>
                          <%= link_to "Profile", edit_user_path(current_user), class: "dropdown-item nav-link dashboard-link" %>
                        </li>
                        <li>
                          <%= button_to "Log Out", destroy_user_session_path, method: :delete, class: "dropdown-item nav-link" %>
                        </li>
                      </ul>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
            <%= yield %>
          </div>
        </div>
      </div>
    <% else %>
      <div class="unauthenticated">
        <div class="image-section"></div>
        <div class="form-section scrollable-form">
          <div id="alertContainerUnauthenticated"></div>
          <div class="form-container">
            <%= yield %>
          </div>
        </div>
      </div>
    <% end %>
  </body>
</html>

<script>
  $(document).ready(function() {
    let deleteButtonStored = null;
    
    hide_spinner();
    const dashboardLinks = document.querySelectorAll('.dashboard-link');

    dashboardLinks.forEach(link => {
      link.addEventListener('click', function(event) {
        event.preventDefault();
        show_spinner();

        window.location.href = this.href;
      });
    });

    $('.select2').select2({
      width: '100%',
      dropdownAutoWidth: true
    });

    $('.datepicker').datepicker({
      format: 'mm/dd/yyyy',
      autoclose: true,
      orientation: 'bottom'
    });

    $('.datepicker-icon').on('click', function() {
      const $input = $(this).closest('.input-group').find('.datepicker');
      $input.datepicker('show');
    });

    var rowCount = $('#content-table tbody tr').length;
    $('#currentCount').text(rowCount);
    updateRecordLabel(rowCount);

    $("#content-search").on("input",applySearchFilter);
  });
  
  function applySearchFilter() {
    var value = $('#content-search').val().toLowerCase();

    if (value === "") {
      $("#content-table-body tr").show();
    } else {
      $("#content-table-body tr").filter(function() {
        $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
      });
    }

    var visibleCount = $("#content-table-body tr:visible").length;
    $('#currentCount').text(visibleCount);
    updateRecordLabel(visibleCount);
  }

  function deleteUser(event, confirmDelete = false) {
    event.preventDefault();

    const button = event.currentTarget;
    const confirmMessage = `Are you sure you want to delete this User?`;

    if (!confirmDelete) {
      deleteUserButtonStored = button;

      document.getElementById("delete-modal-message").innerText = confirmMessage;
      document.getElementById("modalTitle").innerText = "Delete User";

      const modal = new bootstrap.Modal(document.getElementById("deleteConfirmModal"));
      modal.show();

      document.getElementById("modalDeleteConfirmButton").onclick = (e) =>
        deleteUser(e, true);
      return;
    }

    const form = deleteUserButtonStored.closest("form");
    if (form) {
      form.submit();
    }
  }

  function deleteEntity(event, confirmDelete = false) {
    event.preventDefault();

    if (!confirmDelete) {
      deleteButtonStored = event.currentTarget;

      const entityName = deleteButtonStored.dataset.entityName;
      document.getElementById("delete-modal-message").innerText =
        `Are you sure you want to delete this ${entityName}?`;
      document.getElementById("modalTitle").innerText = `Delete ${entityName}`;

      const modal = new bootstrap.Modal(document.getElementById("deleteConfirmModal"));
      modal.show();

      document.getElementById("modalDeleteConfirmButton").onclick = (e) =>
        deleteEntity(e, true);
      return;
    }

    const modalEl = document.getElementById("deleteConfirmModal");
    const modalInstance = bootstrap.Modal.getInstance(modalEl);
    if (modalInstance) modalInstance.hide();

    const button = deleteButtonStored;
    deleteButtonStored = null;

    const entityName = button.dataset.entityName;
    const entity = button.dataset.entity;
    const id = button.dataset.id;

    fetch(`/${entity}/${id}`, {
      method: "DELETE",
      headers: {
        "X-CSRF-Token": document.querySelector("meta[name='csrf-token']").content,
        "Accept": "application/json"
      }
    })
    .then(response => {
      if (response.status === 204 || response.headers.get("Content-Length") === "0") {
        return { ok: response.ok, data: null };
      }
      return response.json().then(data => ({ ok: response.ok, data }));
    })
    .then(({ ok, data }) => {
      if (ok) {
        const row = button.closest("tr");
        if (row) row.remove();
        applySearchFilter();

        const totalElement = document.getElementById("totalCount");
        if (totalElement) {
          let newCount = parseInt(totalElement.innerText) - 1;
          totalElement.innerText = newCount >= 0 ? newCount : 0;
        }

        alertMessage(`${entityName} was deleted`, "SUCCESS", 1000);
      } else {
        const errorMsg = data.errors ? data.errors.join(", ") : `Failed to delete ${entityName}`;
        alertMessage(errorMsg, "DANGER", 2000);
      }
    })
    .catch(error => {
      console.error(`Error deleting ${entityName}:`, error);
    });
  }

  function hide_spinner(){
    document.getElementById("overlay").style.display = "none";
    $('#spinner').hide();
  }

  function show_spinner(){
    document.getElementById("overlay").style.display = "block";
    $('#spinner').show();
  }

  function updateRecordLabel(count) {
    $('#currentCount').text(count.toLocaleString());
    const label = $('#recordLabel');
    const singular = label.data('singular');
    const plural = label.data('plural');
    label.text(count === 1 ? singular : plural);
  }

  var currentAlertIds = {
    INFO: null,
    SUCCESS: null,
    DANGER: null
  };

  function alertMessage(message, messageType, delayTime = 1000) {
    console.log(message);
    
    var alertTypeKey = messageType.toUpperCase();

    // Update existing alert of the same type if it exists
    if (currentAlertIds[alertTypeKey]) {
      $('#' + currentAlertIds[alertTypeKey] + ' .alert-heading').text(message);
      return;
    }

    // Clear existing alerts of different types
    Object.keys(currentAlertIds).forEach(key => {
      if (currentAlertIds[key] && key !== alertTypeKey) {
        $('#' + currentAlertIds[key]).remove();
        currentAlertIds[key] = null;
      }
    });

    var alertId = "alert-" + uuidv4();
    
    <% if user_signed_in? %>
      var alertContainerHTML =
      '<div class="alert" id="' + alertId + '" role="alert" style="text-align: center; z-index: 9999; margin: 1em; margin-left: 250px;">' +
      '<h5 class="alert-heading">' + message + '</h5>' +
      '</div>';
    <% else %>
      var alertContainerHTML =
      '<div class="alert" id="' + alertId + '" role="alert" style="text-align: center; z-index: 9999; margin: 1em;">' +
      '<h5 class="alert-heading">' + message + '</h5>' +
      '</div>';
    <% end %>
    
    <% if user_signed_in? %>
      $('#alertContainer').append(alertContainerHTML);
    <% else %>
      $('#alertContainerUnauthenticated').append(alertContainerHTML);
    <% end %>
    
    // Assign the alert type classes based on messageType
    var $alert = $('#' + alertId);
    if (messageType === "SUCCESS") {
      $alert.addClass("alert-success");
    } else if (messageType === "DANGER") {
      $alert.addClass("alert-danger");
    } else if (messageType === "INFO") {
      $alert.addClass("alert-info");
    }

    <% if user_signed_in? %>
      $("#alertContainer").show();
    <% else %>
      $('#alertContainerUnauthenticated').show();
    <% end %>
    
    // Auto-dismiss logic
    $alert.delay(delayTime).fadeOut(250, function() {
      $(this).remove();
      if (currentAlertIds[alertTypeKey] === alertId) {
        currentAlertIds[alertTypeKey] = null;
      }
    });
  }

  function uuidv4() {
    return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
      (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
    );
  }

  $('th').click(function() {
    // skip if this <th> is inside a modal
    if ($(this).closest('.modal').length > 0) {
      return;
    }
    
    var table = $(this).parents('table').eq(0);
    var rows = table.find('tbody tr').toArray();
    
    var column = $(this).index();
    var asc = $(this).hasClass('asc');

    rows.sort(function(a, b) {
      var aVal = $(a).children('td').eq(column).text();
      var bVal = $(b).children('td').eq(column).text();

      // Clean currency: remove $, commas, trim spaces
      aVal = aVal.replace(/[$,]/g, '').trim();
      bVal = bVal.replace(/[$,]/g, '').trim();

      // Check if the values are percentages
      if (aVal.endsWith('%') && bVal.endsWith('%')) {
        aVal = parseFloat(aVal.replace('%', ''));
        bVal = parseFloat(bVal.replace('%', ''));
      }

      // Check if the values are dates
      var dateFormat = /^(0?[1-9]|1[0-2])\/(0?[1-9]|[12][0-9]|3[01])\/\d{4} \d{1,2}:\d{2} (AM|PM)$/;
      if (dateFormat.test(aVal) && dateFormat.test(bVal)) {
        aVal = new Date(aVal);
        bVal = new Date(bVal);
        return asc ? aVal - bVal : bVal - aVal;
      }

      // Check if the values are numeric
      if ($.isNumeric(aVal) && $.isNumeric(bVal)) {
        return asc ? parseFloat(aVal) - parseFloat(bVal) : parseFloat(bVal) - parseFloat(aVal);
      }

      // Default string comparison
      return asc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
    });

    $.each(rows, function(index, row) {
      table.children('tbody').append(row);
    });

    $('th').removeClass('asc desc');
    $(this).addClass(asc ? 'desc' : 'asc');

  });

  <% if flash[:success] %>
    alertMessage('<%= j flash[:success] %>','SUCCESS', 1500);
  <% elsif flash[:danger] %>
    alertMessage('<%= j flash[:danger] %>','DANGER', 2000);
  <% elsif flash[:notice] %>
    alertMessage('<%= j flash[:notice] %>','INFO', 1500);
  <% end %>
</script>