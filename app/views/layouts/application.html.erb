<!DOCTYPE html>
<html>
  <head>
    <title>Smith & Davis Sales App</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="turbo-prefetch" content="false">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= favicon_link_tag 'favicon.ico' %>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Quicksand">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Handjet">

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    >

    <!-- Bootstrap Select CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css"
    >

    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <!-- Bootstrap Datepicker CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.10.0/dist/css/bootstrap-datepicker.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />

    <!-- Your app's stylesheet -->
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>

    <!-- jQuery (must load first for Bootstrap & Bootstrap Select) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <!-- Popper (needed by Bootstrap) -->
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
      crossorigin="anonymous"
    ></script>

    <!-- Bootstrap JS Bundle (includes Bootstrap's JS but NOT jQuery) -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
      integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
      crossorigin="anonymous"
    ></script>

    <!-- Bootstrap Select JS (must load after jQuery & Bootstrap JS) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>

    <!-- Select2 js -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <!-- Bootstrap Datepicker JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.10.0/dist/js/bootstrap-datepicker.min.js"></script>

    <!-- Luxon -->
    <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>

    <!-- Highcharts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/12.3.0/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>

    <!-- Excel -->
    <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <%= javascript_importmap_tags %>

    <style>
      :root {
        --main-color: #193856;
        --hover-color: #052748;
        --delete-color: #a8504b;
        --delete-hover-color: #964642;
      }

      html, body {
        height: 100%;
        width: 100%;
        margin: 0px;
        padding: 0px;
        font-family: 'Quicksand';
      }

      th.stick {
        background-color: white;
        cursor: pointer;
        position: sticky;
        text-align: center;
        top: 0; 
      }

      th, td {
        text-align: center;
        width: 100px;
      }

      th:hover {
        cursor: pointer;
      }

      #alertContainer {
        position: fixed;
        right: 50%;
        top: .25em;
        transform: translateX(50%);
        z-index: 9999;
      }

      #alertContainerUnauthenticated {
        position: absolute;
        top: 10px;
      }

      #content-main {
        height: calc(100vh - 70px - 75px);
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      #content-search {
        flex: 1;
        margin-right: 5px;
        box-shadow: 0 .05rem .05rem rgba(0, 0, 0, 0.05) !important;
      }

      #nav-sidebar {
        background-color: var(--main-color); 
        color: white; 
        height: 100vh; 
        left: 0;
        position: fixed;
        top: 0;
        width: 250px;
        max-width: 250px;
        min-width: 250px;
        z-index: 9999;
      }

      #nav-sidebar .list-group-item {
        background-color: var(--main-color); 
        border: none;
        padding: 0;
      }  

      #nav-sidebar .sidebar-nav-link {
        color: white;
        display: block;
        font-size: 16px;
        padding: 15px 20px;
        text-decoration: none;
      }

      #nav-sidebar .sidebar-nav-link:hover, .sidebar-nav-link.active {
        background-color: var(--hover-color);
        color: white !important;
      }

      #overlay {
        display: none;
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background-color: rgba(0,0,0,0.5);
        z-index: 9999;
      }

      #recordCount{
        margin-top: auto;
        text-align: center;
      }

      #spinner{
        z-index: 9999; 
        width: 100px; 
        height: 100px;
        color: var(--main-color);
      }

      #total-sales-chart {
        flex: 1;
        width: 100%;
        min-height: 0;
        height: calc(100vh - 155px);
        overflow-x: auto !important;
        overflow-y: hidden;
      }

      .authenticated {
        background: white;
        background-attachment: fixed;
        background-position: center;
        background-repeat: no-repeat;
        background-size: cover;
      }

      .authenticated, .unauthenticated {
        height: 100%; 
        overflow: hidden;
      }

      .brand {
        font-family: 'Handjet';
      }

      .bootstrap-select > .dropdown-toggle,
      .bootstrap-select > .dropdown-toggle:focus,
      .bootstrap-select > .dropdown-toggle:hover
      {
        background-color: #e3e7ebff !important;
      }

      .bootstrap-select.filter-select .dropdown-menu.inner {
        max-height: 300px;
        overflow-y: auto !important;
      }

      .bootstrap-select .dropdown-menu li a span.check-mark {
        color: var(--main-color) !important;
      }

      .btn-delete {
        background-color: var(--delete-color);
        color: white !important;
      }

      .btn-delete:hover,
      .btn-delete:focus,
      .btn-delete:active{
        background-color: var(--delete-hover-color) !important;
        color: white !important;
      }

      .btn-main {
        background-color: var(--main-color) !important;
        color: white !important;
      }

      .btn-main:hover,
      .btn-main:focus,
      .btn-main:active{
        background-color: var(--hover-color) !important;
        color: white !important;
      }

      .btn-left {
        margin-left: 5px;
        margin-top: 10px;
      }

      .btn-right {
        margin-right: 5px; 
        margin-top: 10px;
      }

      .custom-modal {
        max-height: 90vh;
      }

      .custom-checkbox input[type="checkbox"] {
        display: none;
      }

      .custom-checkbox .checkmark {
        background-color: transparent;
        border: 1px solid var(--main-color) !important;
        border-radius: 4px;
        cursor: pointer;
        display: inline-block;
        height: 20px;
        margin-top: 7px;
        position: relative;
        width: 20px;
      }

      .custom-checkbox .checkmark:after {
        border: solid white;
        border-width: 0 3px 3px 0;
        content: "";
        display: none;
        height: 10px;
        left: 6px;
        position: absolute;
        top: 2px;
        transform: rotate(45deg);
        width: 6px;
      }

      .custom-checkbox input[type="checkbox"]:checked + .checkmark {
        background-color: var(--main-color);
      }

      .custom-checkbox input[type="checkbox"]:checked + .checkmark:after {
        display: block;
      }

      .dashboard-content {
        height: calc(100vh - 80px);
        display: flex;
        flex-direction: column;
        overflow-y: hidden;
      }

      .datepicker table tr td.active, .datepicker table tr td.active:hover, .datepicker table tr td span.active, .datepicker table tr td span.active:hover, .bootstrap-select .dropdown-menu li a:active {
        background-image: none;
        background-color: var(--main-color) !important;
      }

      .dropdown-item.nav-link:focus,
      .dropdown-item.nav-link:active,
      .dropdown-item.nav-link.active {
        background-color: inherit;
        box-shadow: none;
        color: inherit;
        outline: none;
      }

      .dropdown-item.nav-link:focus-visible {
        outline: none;
      }

      .form-container {
        max-width: 450px;
        width: 100%;
      }

      .form-container h3 {
        margin-bottom: 20px;
        text-align: center;
      }

      input.form-control.datepicker {
        height: 38px;               
        padding: 6px 12px;         
        border: 1px solid #ced4da;
        border-radius: 4px;
        box-sizing: border-box;
        font-size: 1rem;
        line-height: 1.5;
      }

      .list-group-item {
        border: none;
        text-align: center;
      }

      .logo {
        width: 230px;
        margin-top: 10px;
      }

      .main-content {
        flex-grow: 1;
        display: flex;
        flex-direction: column; 
        overflow-x: hidden;
        scrollbar-width: none;
        margin-top: 70px;
        min-height: 100vh;
        overflow-y: hidden;
      }

      .main-content::-webkit-scrollbar {
        display: none;
      }

      .modal-content {
        width: 750px !important;
      }

      .nav-link, .nav-link:visited {
        color: var(--main-color);
      }

      .nav-link:hover {
        color: var(--hover-color);
      }

      /* goes with .custom-modal */
      .scrollable-table {
        max-height: 85vh;
      }

      .scrollable-form {
        flex-grow: 1;
      }
      
      .scrollable-form, .scrollable-table {
        overflow-y: auto;
        scrollbar-width: none;
      }

      .search-form {
        height: 40px;
        margin-top: 5px;
        max-width: 300px;
        width: 100%;
      }

      .select2-container--default .select2-results__option--highlighted[aria-selected] {
        background-color: var(--main-color) !important;
        color: white !important;
      }

      .select2-container--default .select2-selection--single {
        height: 38px;
        padding: 6px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
      }

      .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 38px;
      }

      .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 24px;
      }

      .separator {
        border: 1px solid black;
        margin-top: 20px;
        margin-bottom: 20px;
        border-radius: 1px;
      }

      .show-scrollbar {
        overflow-y: auto !important;
        scrollbar-width: auto !important;              
      }

      .unauthenticated {
        display: flex;
        height: 100vh;
      }

      @media (max-width: 767.98px) {
        .custom-modal {
          margin-left: 250px !important;
          margin-right: auto !important;
        }
      }

      @media(max-height: 650px){
        .custom-modal{
          max-height: 80vh !important;
        }

        .scrollable-table {
          max-height: 75vh !important;
        }

        .main-content-row {
          max-height: calc(100vh - 59px - 20px);
          display: flex;
        }

        .left-col,
        .right-col {
          display: flex;
          flex-direction: column;
        }

        .left-col .card:last-child,
        .right-col .card {
          flex: 1 1 auto;
          display: flex;
          flex-direction: column;
        }

        .dashboard-content {
          height: calc(100vh - 155px);
          display: flex;
          flex-direction: column;
          overflow-y: hidden;
        }

        #total-sales-chart {
          flex: 1;
          width: 100%;
          min-height: 0;
          height: calc(100vh - 145px);
          overflow-x: auto !important;
          overflow-y: hidden;
        }
      }
    </style>
  </head>

  <body>
    <div style="height: 0;">
      <div id="alertContainer"></div>
      <div id="overlay">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
          <div class="spinner-border" id="spinner" role="status"></div>
        </div>
      </div>
    </div>

    <div class="d-flex flex-column h-100 authenticated">
      <div class="container-fluid h-100 d-flex flex-row p-0">
        <div class="position-relative d-flex flex-column" id="nav-sidebar">
          
          <div class="row">
            <div class="col">
              <h4 class="text-center">
                <%= image_tag 'logo.png', class: "logo" %>
              </h4>
            </div>
          </div>
          
          <div class="row flex-grow-1 align-items-center">
            <div class="col">
              <ul class="list-group list-group-flush">
                <li class="list-group-item">
                  <%= link_to "Dashboard", dashboard_path, class: "dashboard-link sidebar-nav-link #{'active' if current_page?(dashboard_path) or current_page?(root_path)}" %>
                </li>
                <li class="list-group-item">
                  <%= link_to "Sales People", sales_people_path, class: "dashboard-link sidebar-nav-link #{'active' if current_page?(sales_people_path)}" %>
                </li>
                <li class="list-group-item">
                  <%= link_to "Sales Records", sales_records_path, class: "dashboard-link sidebar-nav-link #{'active' if current_page?(sales_records_path)}" %>
                </li>
              </ul>
            </div>
          </div>  
        </div>

        <div class="main-content">
          <%= yield %>
        </div>
    </div>
  </body>
</html>

<script>
  $(document).ready(function() {
    hide_spinner();
    const dashboardLinks = document.querySelectorAll('.dashboard-link');

    dashboardLinks.forEach(link => {
      link.addEventListener('click', function(event) {
        event.preventDefault();
        show_spinner();

        window.location.href = this.href;
      });
    });

    $('.select2').select2({
      width: '100%',
      dropdownAutoWidth: true
    });

    $('.datepicker').datepicker({
      format: 'mm/dd/yyyy',
      autoclose: true,
      orientation: 'bottom'
    });

    $('.datepicker-icon').on('click', function() {
      const $input = $(this).closest('.input-group').find('.datepicker');
      $input.datepicker('show');
    });

    var rowCount = $('#content-table tbody tr').length;
    $('#currentCount').text(rowCount);
    updateRecordLabel(rowCount);

    $("#content-search").on("input",applySearchFilter);
  });
  
  function applySearchFilter() {
    var value = $('#content-search').val().toLowerCase();

    if (value === "") {
      $("#content-table-body tr").show();
    } else {
      $("#content-table-body tr").filter(function() {
        $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
      });
    }

    var visibleCount = $("#content-table-body tr:visible").length;
    $('#currentCount').text(visibleCount);
    updateRecordLabel(visibleCount);
  }

  function confirmAndShowSpinner(event, confirmMessage) {
    
    if (!confirm(confirmMessage)) {
      // If the user clicks "Cancel", prevent the form submission
      event.preventDefault();
      return false;
    }

    show_spinner();
  }

  function deleteEntity(event) {
    event.preventDefault();

    const button = event.currentTarget;
    const entityName = button.dataset.entityName;
    
    if (!confirm(`Are you sure you want to delete this ${entityName}?`)) return;

    const entity = button.dataset.entity;
    const id = button.dataset.id;

    if (!entity || !id) {
      console.error("Missing entity or id on delete button");
      return;
    }

    fetch(`/${entity}/${id}`, {
      method: "DELETE",
      headers: {
        "X-CSRF-Token": document.querySelector("meta[name='csrf-token']").content,
        "Accept": "application/json"
      }
    })
    .then(response => {
      if (response.status === 204 || response.headers.get("Content-Length") === "0") {
        return { ok: response.ok, data: null };
      }
      return response.json().then(data => ({ ok: response.ok, data }));
    })
    .then(({ ok, data }) => {
      if (ok) {
        const row = button.closest("tr");
        if (row) row.remove();
        applySearchFilter();

        const totalElement = document.getElementById("totalCount");
        if (totalElement) {
          let newCount = parseInt(totalElement.innerText) - 1;
          totalElement.innerText = newCount >= 0 ? newCount : 0;
        }

        alertMessage(`${entityName} was deleted`, "SUCCESS", 2500);
      } else {
        const errorMsg = data.errors ? data.errors.join(", ") : `Failed to delete ${entityName}`;
        alertMessage(errorMsg, "DANGER", 4000);
      }
    })
    .catch(error => {
      console.error(`Error deleting ${entityName}:`, error);
    });
  }

  function hide_spinner(){
    document.getElementById("overlay").style.display = "none";
    $('#spinner').hide();
  }

  function show_spinner(){
    document.getElementById("overlay").style.display = "block";
    $('#spinner').show();
  }

  function updateRecordLabel(count) {
    $('#currentCount').text(count.toLocaleString());
    const label = $('#recordLabel');
    const singular = label.data('singular');
    const plural = label.data('plural');
    label.text(count === 1 ? singular : plural);
  }

  var currentAlertIds = {
    INFO: null,
    SUCCESS: null,
    DANGER: null
  };

  function alertMessage(message, messageType, delayTime = 2500) {
    console.log(message);
    
    var alertTypeKey = messageType.toUpperCase();

    // Update existing alert of the same type if it exists
    if (currentAlertIds[alertTypeKey]) {
      $('#' + currentAlertIds[alertTypeKey] + ' .alert-heading').text(message);
      return;
    }

    // Clear existing alerts of different types
    Object.keys(currentAlertIds).forEach(key => {
      if (currentAlertIds[key] && key !== alertTypeKey) {
        $('#' + currentAlertIds[key]).remove();
        currentAlertIds[key] = null;
      }
    });

    var alertId = "alert-" + uuidv4();
    
    var alertContainerHTML =
      '<div class="alert" id="' + alertId + '" role="alert" style="text-align: center; z-index: 9999; margin: 1em; margin-left: 250px;">' +
      '<h5 class="alert-heading">' + message + '</h5>' +
      '</div>';
    
    $('#alertContainer').append(alertContainerHTML);
    
    // Assign the alert type classes based on messageType
    var $alert = $('#' + alertId);
    if (messageType === "SUCCESS") {
      $alert.addClass("alert-success");
    } else if (messageType === "DANGER") {
      $alert.addClass("alert-danger");
    } else if (messageType === "INFO") {
      $alert.addClass("alert-info");
    }

    $("#alertContainer").show();
    
    // Auto-dismiss logic
    if (messageType !== "INFO" || !isJobStatusAlert) {
      $alert.delay(delayTime).fadeOut(250, function() {
        $(this).remove();
        if (currentAlertIds[alertTypeKey] === alertId) {
          currentAlertIds[alertTypeKey] = null;
        }
      });
    } else if (isJobStatusAlert) {
      currentAlertIds[alertTypeKey] = alertId;
    }
  }

  function uuidv4() {
    return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
      (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
    );
  }

  $('th').click(function() {
    
    // skip if this <th> is inside a modal
    if ($(this).closest('.modal').length > 0) {
      return;
    }
    
    var table = $(this).parents('table').eq(0);
    var rows = table.find('tbody tr').toArray();
    
    var column = $(this).index();
    var asc = $(this).hasClass('asc');

    rows.sort(function(a, b) {
      var aVal = $(a).children('td').eq(column).text();
      var bVal = $(b).children('td').eq(column).text();

      // Clean currency: remove $, commas, trim spaces
      aVal = aVal.replace(/[$,]/g, '').trim();
      bVal = bVal.replace(/[$,]/g, '').trim();

      // Check if the values are percentages
      if (aVal.endsWith('%') && bVal.endsWith('%')) {
        aVal = parseFloat(aVal.replace('%', ''));
        bVal = parseFloat(bVal.replace('%', ''));
      }

      // Check if the values are dates
      var dateFormat = /^(0?[1-9]|1[0-2])\/(0?[1-9]|[12][0-9]|3[01])\/\d{4} \d{1,2}:\d{2} (AM|PM)$/;
      if (dateFormat.test(aVal) && dateFormat.test(bVal)) {
        aVal = new Date(aVal);
        bVal = new Date(bVal);
        return asc ? aVal - bVal : bVal - aVal;
      }

      // Check if the values are numeric
      if ($.isNumeric(aVal) && $.isNumeric(bVal)) {
        return asc ? parseFloat(aVal) - parseFloat(bVal) : parseFloat(bVal) - parseFloat(aVal);
      }

      // Default string comparison
      return asc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
    });

    $.each(rows, function(index, row) {
      table.children('tbody').append(row);
    });

    $('th').removeClass('asc desc');
    $(this).addClass(asc ? 'desc' : 'asc');

  });

  <% if flash[:success] %>
    alertMessage('<%= j flash[:success] %>','SUCCESS', 2500);
  <% elsif flash[:danger] %>
    alertMessage('<%= j flash[:danger] %>','DANGER', 3000);
  <% elsif flash[:notice] %>
    alertMessage('<%= j flash[:notice] %>','INFO',2500);
  <% end %>
</script>