<!DOCTYPE html>
<html>
  <head>
    <title>Smith & Davis Sales App</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="turbo-prefetch" content="false">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= favicon_link_tag 'favicon.png', rel: 'icon', type: 'image/png', sizes: '96x96' %>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Quicksand">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Handjet">

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    >

    <!-- Bootstrap Select CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css"
    >

    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <!-- Bootstrap Datepicker CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.10.0/dist/css/bootstrap-datepicker.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />

    <!-- jQuery (must load first for Bootstrap & Bootstrap Select) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <!-- Popper (needed by Bootstrap) -->
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
      crossorigin="anonymous"
    ></script>

    <!-- Bootstrap JS Bundle (includes Bootstrap's JS but NOT jQuery) -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
      integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
      crossorigin="anonymous"
    ></script>

    <!-- Bootstrap Select JS (must load after jQuery & Bootstrap JS) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>

    <!-- Select2 js -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <!-- Bootstrap Datepicker JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.10.0/dist/js/bootstrap-datepicker.min.js"></script>

    <!-- Luxon -->
    <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>

    <!-- Highcharts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/12.3.0/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>

    <!-- Excel -->
    <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <%= javascript_importmap_tags %>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>

  </head>

        .left-col .card:last-child,
        .right-col .card {
          flex: 1 1 auto;
          display: flex;
          flex-direction: column;
        }

        .dashboard-content {
          height: calc(100vh - 155px);
          display: flex;
          flex-direction: column;
          overflow-y: hidden;
        }

        #total-sales-chart {
          flex: 1;
          width: 100%;
          min-height: 0;
          height: calc(100vh - 145px);
          overflow-x: auto !important;
          overflow-y: hidden;
        }
      }
    </style>
  </head>

  <body>
    <div style="height: 0;">
      <div id="alertContainer"></div>
      <div id="overlay">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
          <div class="spinner-border" id="spinner" role="status"></div>
        </div>
      </div>
    </div>

    <div class="d-flex flex-column h-100 authenticated">
      <div class="container-fluid h-100 d-flex flex-row p-0">
        <div class="position-relative d-flex flex-column" id="nav-sidebar">
          
          <div class="row">
            <div class="col">
              <h4 class="text-center">
                <%= image_tag 'logo.png', class: "logo" %>
              </h4>
            </div>
          </div>
          
          <div class="row flex-grow-1 align-items-center">
            <div class="col">
              <ul class="list-group list-group-flush">
                <li class="list-group-item">
                  <%= link_to "Dashboard", dashboard_path, class: "dashboard-link sidebar-nav-link #{'active' if current_page?(dashboard_path) or current_page?(root_path)}" %>
                </li>
                <li class="list-group-item">
                  <%= link_to "Sales People", sales_people_path, class: "dashboard-link sidebar-nav-link #{'active' if current_page?(sales_people_path)}" %>
                </li>
                <li class="list-group-item">
                  <%= link_to "Sales Records", sales_records_path, class: "dashboard-link sidebar-nav-link #{'active' if current_page?(sales_records_path)}" %>
                </li>
              </ul>
            </div>
          </div>  
        </div>

        <div class="main-content">
          <%= yield %>
        </div>
    </div>
  </body>
</html>

<script>
  $(document).ready(function() {
    hide_spinner();
    const dashboardLinks = document.querySelectorAll('.dashboard-link');

    dashboardLinks.forEach(link => {
      link.addEventListener('click', function(event) {
        event.preventDefault();
        show_spinner();

        window.location.href = this.href;
      });
    });

    $('.select2').select2({
      width: '100%',
      dropdownAutoWidth: true
    });

    $('.datepicker').datepicker({
      format: 'mm/dd/yyyy',
      autoclose: true,
      orientation: 'bottom'
    });

    $('.datepicker-icon').on('click', function() {
      const $input = $(this).closest('.input-group').find('.datepicker');
      $input.datepicker('show');
    });

    var rowCount = $('#content-table tbody tr').length;
    $('#currentCount').text(rowCount);
    updateRecordLabel(rowCount);

    $("#content-search").on("input",applySearchFilter);
  });
  
  function applySearchFilter() {
    var value = $('#content-search').val().toLowerCase();

    if (value === "") {
      $("#content-table-body tr").show();
    } else {
      $("#content-table-body tr").filter(function() {
        $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
      });
    }

    var visibleCount = $("#content-table-body tr:visible").length;
    $('#currentCount').text(visibleCount);
    updateRecordLabel(visibleCount);
  }

  function confirmAndShowSpinner(event, confirmMessage) {
    
    if (!confirm(confirmMessage)) {
      // If the user clicks "Cancel", prevent the form submission
      event.preventDefault();
      return false;
    }

    show_spinner();
  }

  function deleteEntity(event) {
    event.preventDefault();

    const button = event.currentTarget;
    const entityName = button.dataset.entityName;
    
    if (!confirm(`Are you sure you want to delete this ${entityName}?`)) return;

    const entity = button.dataset.entity;
    const id = button.dataset.id;

    if (!entity || !id) {
      console.error("Missing entity or id on delete button");
      return;
    }

    fetch(`/${entity}/${id}`, {
      method: "DELETE",
      headers: {
        "X-CSRF-Token": document.querySelector("meta[name='csrf-token']").content,
        "Accept": "application/json"
      }
    })
    .then(response => {
      if (response.status === 204 || response.headers.get("Content-Length") === "0") {
        return { ok: response.ok, data: null };
      }
      return response.json().then(data => ({ ok: response.ok, data }));
    })
    .then(({ ok, data }) => {
      if (ok) {
        const row = button.closest("tr");
        if (row) row.remove();
        applySearchFilter();

        const totalElement = document.getElementById("totalCount");
        if (totalElement) {
          let newCount = parseInt(totalElement.innerText) - 1;
          totalElement.innerText = newCount >= 0 ? newCount : 0;
        }

        alertMessage(`${entityName} was deleted`, "SUCCESS", 1000);
      } else {
        const errorMsg = data.errors ? data.errors.join(", ") : `Failed to delete ${entityName}`;
        alertMessage(errorMsg, "DANGER", 2000);
      }
    })
    .catch(error => {
      console.error(`Error deleting ${entityName}:`, error);
    });
  }

  function hide_spinner(){
    document.getElementById("overlay").style.display = "none";
    $('#spinner').hide();
  }

  function show_spinner(){
    document.getElementById("overlay").style.display = "block";
    $('#spinner').show();
  }

  function updateRecordLabel(count) {
    $('#currentCount').text(count.toLocaleString());
    const label = $('#recordLabel');
    const singular = label.data('singular');
    const plural = label.data('plural');
    label.text(count === 1 ? singular : plural);
  }

  var currentAlertIds = {
    INFO: null,
    SUCCESS: null,
    DANGER: null
  };

  function alertMessage(message, messageType, delayTime = 1000) {
    console.log(message);
    
    var alertTypeKey = messageType.toUpperCase();

    // Update existing alert of the same type if it exists
    if (currentAlertIds[alertTypeKey]) {
      $('#' + currentAlertIds[alertTypeKey] + ' .alert-heading').text(message);
      return;
    }

    // Clear existing alerts of different types
    Object.keys(currentAlertIds).forEach(key => {
      if (currentAlertIds[key] && key !== alertTypeKey) {
        $('#' + currentAlertIds[key]).remove();
        currentAlertIds[key] = null;
      }
    });

    var alertId = "alert-" + uuidv4();
    
    var alertContainerHTML =
      '<div class="alert" id="' + alertId + '" role="alert" style="text-align: center; z-index: 9999; margin: 1em; margin-left: 250px;">' +
      '<h5 class="alert-heading">' + message + '</h5>' +
      '</div>';
    
    $('#alertContainer').append(alertContainerHTML);
    
    // Assign the alert type classes based on messageType
    var $alert = $('#' + alertId);
    if (messageType === "SUCCESS") {
      $alert.addClass("alert-success");
    } else if (messageType === "DANGER") {
      $alert.addClass("alert-danger");
    } else if (messageType === "INFO") {
      $alert.addClass("alert-info");
    }

    $("#alertContainer").show();
    
    // Auto-dismiss logic
    $alert.delay(delayTime).fadeOut(250, function() {
      $(this).remove();
      if (currentAlertIds[alertTypeKey] === alertId) {
        currentAlertIds[alertTypeKey] = null;
      }
    });
  }

  function uuidv4() {
    return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
      (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
    );
  }

  $('th').click(function() {
    
    // skip if this <th> is inside a modal
    if ($(this).closest('.modal').length > 0) {
      return;
    }
    
    var table = $(this).parents('table').eq(0);
    var rows = table.find('tbody tr').toArray();
    
    var column = $(this).index();
    var asc = $(this).hasClass('asc');

    rows.sort(function(a, b) {
      var aVal = $(a).children('td').eq(column).text();
      var bVal = $(b).children('td').eq(column).text();

      // Clean currency: remove $, commas, trim spaces
      aVal = aVal.replace(/[$,]/g, '').trim();
      bVal = bVal.replace(/[$,]/g, '').trim();

      // Check if the values are percentages
      if (aVal.endsWith('%') && bVal.endsWith('%')) {
        aVal = parseFloat(aVal.replace('%', ''));
        bVal = parseFloat(bVal.replace('%', ''));
      }

      // Check if the values are dates
      var dateFormat = /^(0?[1-9]|1[0-2])\/(0?[1-9]|[12][0-9]|3[01])\/\d{4} \d{1,2}:\d{2} (AM|PM)$/;
      if (dateFormat.test(aVal) && dateFormat.test(bVal)) {
        aVal = new Date(aVal);
        bVal = new Date(bVal);
        return asc ? aVal - bVal : bVal - aVal;
      }

      // Check if the values are numeric
      if ($.isNumeric(aVal) && $.isNumeric(bVal)) {
        return asc ? parseFloat(aVal) - parseFloat(bVal) : parseFloat(bVal) - parseFloat(aVal);
      }

      // Default string comparison
      return asc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
    });

    $.each(rows, function(index, row) {
      table.children('tbody').append(row);
    });

    $('th').removeClass('asc desc');
    $(this).addClass(asc ? 'desc' : 'asc');

  });

  <% if flash[:success] %>
    alertMessage('<%= j flash[:success] %>','SUCCESS', 1000);
  <% elsif flash[:danger] %>
    alertMessage('<%= j flash[:danger] %>','DANGER', 2000);
  <% elsif flash[:notice] %>
    alertMessage('<%= j flash[:notice] %>','INFO', 1000);
  <% end %>
</script>