<style>
  @media(max-height: 580px) {
    .dashboard-content,
    .right-col,
    .left-col,
    .main-content-row {
      height: 100%;
      min-height: 0;
    }
    .dashboard-content {
      overflow: hidden;
    }
    
    #filterCard {
      padding-top: 0.5rem;         
      padding-bottom: 0.25rem;
      padding-left: 1rem;
      padding-right: 1rem;
    }

    #selectDateRange {
      height: calc(100vh - 70px);
    }
  }

  @media (min-height: 581px) and (max-height: 650px) {
    
    .dashboard-content,
    .right-col,
    .left-col,
    .main-content-row {
      height: 100%;
      min-height: 0;
    }
    
    #filterCard {
      padding-top: 1rem;
      padding-left: 1rem;
      padding-right: 1rem;
    }

    #filterHeader {
      margin-top: 0.75rem;
    }

    #sellDateFilter {
      margin-bottom: 0.75rem;
    }

    #selectDateRange {
      height: calc(100vh - 150px);
    }
  }

  @media(min-height: 651px){
    #filterCard {
      padding: 1.25rem;
    }

    #selectDateRange {
      height: calc(100vh - 100px);
    }
  }
</style>

<% if @start_date.blank? || @end_date.blank? %>
  <div class="d-flex justify-content-center align-items-center" id="selectDateRange">
    <div class="card p-4" style="max-width: 400px; width: 100%;">
      <h4 class="mb-3 text-center">Select a Date Range</h4>
      <%= form_with url: dashboard_path, method: :get, local: true do |form| %>
        <div class="mb-3">
          <%= form.label :start_date, "Start Date", class: "form-label" %>
          <div class="input-group">
            <%= form.text_field :start_date, class: "form-control datepicker", required: true, value: (params[:start_date].presence || Date.current.strftime("%m/%d/%Y")) %>
            <span class="input-group-text datepicker-icon">
              <i class="bi bi-calendar-date"></i>
            </span>
          </div>
        </div>
        <div class="mb-3">
          <%= form.label :end_date, "End Date", class: "form-label" %>
          <div class="input-group">
            <%= form.text_field :end_date, class: "form-control datepicker", required: true, value: (params[:end_date].presence || Date.current.strftime("%m/%d/%Y")) %>
            <span class="input-group-text datepicker-icon">
              <i class="bi bi-calendar-date"></i>
            </span>
          </div>
        </div>
        <div class="d-flex justify-content-end">
          <%= form.submit "View Dashboard", class: "btn btn-main", data: { turbo: false }, onclick:"show_spinner()" %>
        </div>
      <% end %>
    </div>
  </div>
<% else %>
  
  <div class="modal fade" id="totalSalesModal" tabindex="-1" aria-labelledby="totalSalesModalLabel" aria-hidden="true">
		<div class="modal-dialog custom-modal">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="totalSalesModalLabel"><b><span id="salesPersonName"></span></b></h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="scrollable-table show-scrollbar">
						<table class="table content" id="totalSalesModalTable">
							<thead>
								<tr>
									<th class="stick" scope="col">Sell Date</th>
                  <th class="stick" scope="col">Items Sold</th>
									<th class="stick" scope="col">Amount Sold</th>
                  <th class="stick" scope="col">Sales Floor Hours</th>
                  <th class="stick" scope="col">Average Per Hour</th>
                  <th class="stick" scope="col">Project Hours</th>
								</tr>
							</thead>
							<tbody id="totalSalesModalTableBody">
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>
  
  <div class="container-fluid">
    <div class="row main-content-row">
      <div class="col-12 col-md-3 left-col">
        <div class="card mb-3 p-4">
          <h5 class="text-center">Change the Date Range</h5>
          <%= form_with url: dashboard_path, method: :get, local: true do |form| %>
            <div class="mb-3">
              <%= form.label :start_date, "Start Date", class: "form-label" %>
              <div class="input-group">
                <%= form.text_field :start_date, class: "form-control datepicker", required: true, value: (params[:start_date].presence || Date.current.strftime("%m/%d/%Y")) %>
                <span class="input-group-text datepicker-icon">
                  <i class="bi bi-calendar-date"></i>
                </span>
              </div>
            </div>

            <div class="mb-2">
              <%= form.label :end_date, "End Date", class: "form-label" %>
              <div class="input-group">
                <%= form.text_field :end_date, class: "form-control datepicker", required: true, value: (params[:end_date].presence || Date.current.strftime("%m/%d/%Y")) %>
                <span class="input-group-text datepicker-icon">
                  <i class="bi bi-calendar-date"></i>
                </span>
              </div>
            </div>

            <div class="d-flex justify-content-end">
              <%= form.submit "Submit", class: "btn btn-main", data: { turbo: false }, onclick:"show_spinner()" %>
            </div>
          <% end %>
        </div>
        
        <div class="card" id="filterCard">
          <h5 class="mb-2 text-center" id="filterHeader">Filters</h5>  
        
          <div class="mb-3 d-flex flex-column align-items-center">
            <select id="sales-person-filter"
                    class="selectpicker btn-secondary filter-select"
                    multiple
                    data-actions-box="true"
                    title="Sales People"
                    data-selected-text-format="count"
                    data-count-selected-text="{0} people selected"
                    data-width="100%">
            </select>
          </div>

          <div class="d-flex flex-column align-items-center" id="sellDateFilter">
            <select id="sell-date-filter"
              class="selectpicker btn-secondary filter-select"
              multiple
              data-actions-box="true"
              title="Sell Date"
              data-selected-text-format="count"
              data-count-selected-text="{0} dates selected"
              data-width="100%">
            </select>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-9 right-col">
        <div class="card dashboard-content">
          <div class="card-body" id="dashboardTabsContent">
            <div class="mb-1 d-flex justify-content-end">
              <button id="export-total-sales-chart" class="btn btn-main">Export to Excel</button>
            </div>
            
            <div id="total-sales-chart"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
<% end %>

<% if @start_date.present? and @end_date.present? %>
  <script>
		$(document).ready(function() {

      function updateFilterSection() {
        const card = document.getElementById("filterCard");
        const selects = document.querySelectorAll('.filter-select');
        const screenHeight = window.innerHeight;

        selects.forEach(select => {
          select.setAttribute('data-dropup-auto', 'false');
          
          // Save desired direction into dataset for later
          if (screenHeight <= 900) {
            select.classList.add('dropup');
          } else {
            select.classList.remove('dropup');
            select.dataset.forceDirection = 'down';
          }
        });
      }

      $(document).on('show.bs.select', '.filter-select', function () {
        const wrapper = $(this).closest('.bootstrap-select');
        const direction = this.dataset.forceDirection;
        if(direction === 'down'){
          wrapper.removeClass('dropup').addClass('dropdown');
        }
      });

      window.addEventListener('resize', updateFilterSection);

      updateFilterSection();

      console.log("Height: " + window.innerHeight);
      
      const salesRecords = <%= raw @sales_records.to_json %>;
			const salesPeople = <%= raw @sales_people.to_json %>;
      const salesPeopleWithoutSales = <%= raw @sales_people_without_sales.to_json %>;
			console.log("Sales Records:", salesRecords);
			console.log("Sales People:", salesPeople);
      console.log("Sales People Without Sales: " + salesPeopleWithoutSales);
			
			const salesPersonIdToName = {};
			salesPeople.forEach(sp => {
				const name = `${sp.first_name} ${sp.last_name}`.trim().replace(/\s+/g, ' ');
				salesPersonIdToName[sp.id] = name;
			});
      
      function addPadding(row){
        row.style.paddingTop = "10px";
        row.style.paddingBottom = "10px";
        return row;
      }
      
      function getFilteredSalesRecords() {
        const selectedSalesPersonIds = $('#sales-person-filter').val() || [];
        const selectedSellDates = $('#sell-date-filter').val() || [];
        
        const filteredRecords = salesRecords.filter(record =>
          selectedSalesPersonIds.includes(String(record.sales_person_id)) &&
          selectedSellDates.includes(record.sell_date)
        );

        return filteredRecords;
      }
      
      function populateSalesPersonSelect() {
				let select = $('#sales-person-filter');
				select.find('option').remove();

				const optionsHtml = Object.entries(salesPersonIdToName)
        .sort((a, b) => a[1].localeCompare(b[1]))
        .map(([id, name]) => new Option(name, id, true, true).outerHTML)
        .join('');

				select.html(optionsHtml);
				select.selectpicker('destroy');
				select.selectpicker();
			}

      function populateSellDateSelect() {
        const select = $('#sell-date-filter');
        select.find('option').remove();

        const uniqueDates = [...new Set(salesRecords.map(r => r.sell_date))].sort();

        const optionsHtml = uniqueDates.map(dateStr => {
          const formattedDate = luxon.DateTime.fromISO(dateStr).toFormat('MM/dd/yyyy');
          return new Option(formattedDate, dateStr, true, true).outerHTML;
        }).join('');

        select.html(optionsHtml);
        select.selectpicker('destroy');
        select.selectpicker();
      }

      function processSalesRecords(){
        const filteredRecords = getFilteredSalesRecords();
        const totalsByPerson = {};
        const grandTotals = {
          amountSold: 0,
          itemsSold: 0,
          projectHours: 0,
          salesFloorHours: 0,
          avgPerHour: 0
        };
        
        filteredRecords.forEach(record => {
          const personId = record.sales_person_id;
          const personName = salesPersonIdToName[personId];
          const sellDate = record.sell_date;

          if (!totalsByPerson[personId]) totalsByPerson[personId] = { name: personName,
          records: {},
            totals: {
              amountSold: 0,
              itemsSold: 0,
              projectHours: 0,
              salesFloorHours: 0
            },
            avgPerHour: 0
          };

          const amountSold = Number(record.amount_sold);
          const itemsSold = Number(record.items_sold);
          const projectHours = Number(record.project_hours);
          const salesFloorHours = Number(record.sales_floor_hours);
    
          totalsByPerson[personId].records[sellDate] = {
            amountSold,
            itemsSold,
            projectHours,
            salesFloorHours
          };

          totalsByPerson[personId].totals.amountSold += amountSold;
          totalsByPerson[personId].totals.itemsSold += itemsSold;
          totalsByPerson[personId].totals.projectHours += projectHours;
          totalsByPerson[personId].totals.salesFloorHours += salesFloorHours;
          
          grandTotals.amountSold += amountSold;
          grandTotals.itemsSold += itemsSold;
          grandTotals.projectHours += projectHours;
          grandTotals.salesFloorHours += salesFloorHours;
        });

        Object.values(totalsByPerson).forEach(person => {
          const totals = person.totals;
          person.avgPerHour =
            totals.salesFloorHours > 0
              ? Number((totals.amountSold / totals.salesFloorHours).toFixed(2))
              : 0;
        });

        grandTotals.avgPerHour = grandTotals.salesFloorHours > 0
        ? Number((grandTotals.amountSold / grandTotals.salesFloorHours).toFixed(2))
        : 0;

        console.log("Totals by Person:", totalsByPerson);
        console.log("Grand Totals:", grandTotals);

        const filteredData = Object.values(totalsByPerson).map(p => ({
          name: p.name,
          totalSales: p.totals.amountSold,
          totalProjectHours: p.totals.projectHours,
          totalSalesHours: p.totals.salesFloorHours,
          itemsSold: p.totals.itemsSold,
          avgPerHour: p.avgPerHour
        })).sort((a, b) => b.totalSales - a.totalSales);

        const categories = filteredData.map(p => p.name);
        const data = filteredData.map(p => ({
          y: p.totalSales,
          custom: {
            project_hours: p.totalProjectHours,
            items_sold: p.itemsSold,
            sales_hours: p.totalSalesHours,
            avg: p.avgPerHour
          }
        }));

        function showTotalSalesForClickedPerson(clickedName){
          const salesPersonId = Object.keys(salesPersonIdToName).find(
            id => salesPersonIdToName[id] === clickedName
          );

          const personData = totalsByPerson[salesPersonId];

          if (!personData) return;

          const recordsByDate = personData.records;
          const tbody = document.querySelector('#totalSalesModalTableBody');
          tbody.innerHTML = '';

          document.getElementById('salesPersonName').textContent = clickedName;
          
          const sortedRecords = Object.entries(personData.records)
          .sort(([dateA], [dateB]) => new Date(dateA) - new Date(dateB));

          sortedRecords.forEach(([isoDate, record]) => {
            const formattedDate = luxon.DateTime.fromISO(isoDate).toFormat('MM/dd/yyyy');
            const dailyTotal = record.amountSold;
            const itemsSold = record.itemsSold;
            const dailyProjectHours = record.projectHours;
            const dailySalesHours = record.salesFloorHours;
            const dailyAvg = dailySalesHours > 0 && dailyTotal > 0 ? (dailyTotal / dailySalesHours).toFixed(2) : 0;

            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${formattedDate}</td>
              <td>${itemsSold}</td>
              <td>$${dailyTotal.toLocaleString()}</td>
              <td>${dailySalesHours}</td>
              <td>$${dailyAvg}</td>
              <td>${dailyProjectHours}</td>
            `;
            tbody.appendChild(row);
          });

          // Only show totals if more than one unique date
          if (sortedRecords.length > 1) {
            const overallAvg = personData.totals.salesFloorHours > 0 ? (personData.totals.amountSold / personData.totals.salesFloorHours).toFixed(2) : 0;

            let spaceRowBefore = document.createElement('tr');
            spaceRowBefore.innerHTML = `
            <td colspan="6"></td>
            `;
            tbody.appendChild(spaceRowBefore);

            const totalRow = document.createElement('tr');
            totalRow.innerHTML = `
              <td><strong>Grand Total</strong></td>
              <td><strong>${personData.totals.itemsSold}</strong></td>
              <td><strong>$${personData.totals.amountSold.toLocaleString()}</strong></td>
              <td><strong>${personData.totals.salesFloorHours}</strong></td>
              <td><strong>$${personData.avgPerHour.toFixed(2)}</strong></td>
              <td><strong>${personData.totals.projectHours}</strong></td>
            `;
            tbody.appendChild(totalRow);
            addPadding(totalRow);

            let spaceRowAfter = document.createElement('tr');
            spaceRowAfter.innerHTML = `
            <td colspan="6"></td>
            `;
            tbody.appendChild(spaceRowAfter);
          }

          const modal = new bootstrap.Modal(document.getElementById('totalSalesModal'));
          modal.show();
        }
        
        Highcharts.chart('total-sales-chart', {
					chart: {
						type: 'column',
            marginTop: 160,
            scrollablePlotArea: {
              minWidth: categories.length * 100,
              scrollPositionX: 1
            }
					},
					title: {
            useHTML: true,
						text: 
            `<div style="text-align: center;">
              <div style="font-size: 22px;">
                <% if @start_date == @end_date %>
                  Sales for <%= @start_date.strftime("%m/%d/%Y") %>
                <% else %>
                  Sales from <%= @start_date.strftime("%m/%d/%Y") %> to <%= @end_date.strftime("%m/%d/%Y") %>
                <% end %>
              </div>
            </div>
            `
					},
					subtitle: {
						useHTML: true,
            text: `
              <div style="text-align: center;">
                <div style="font-size: 18px; font-weight: bold; color: #333;">
                  $${grandTotals.amountSold.toLocaleString()}
                </div>
                <div style="font-size: 14px; font-weight: bold; color: #777;">
                  ${grandTotals.itemsSold.toLocaleString()} sale${grandTotals.itemsSold === 1 ? '' : 's'}
                </div>
              </div>
            `
					},
					xAxis: {
						categories: categories,
						title: { text: 'Sales People' },
					},
					yAxis: {
						min: 0,
						title: { text: 'Total Sales ($)' }
					},
					tooltip: {
						enabled: false
					},
					plotOptions: {
						column: {
							cursor: 'pointer',
							point: {
								events: {
									click: function() {
										showTotalSalesForClickedPerson(this.category);
									}
								}
							},
							dataLabels: {
                enabled: true,
                inside: false,
                crop: false,
                overflow: 'none',
                useHTML: true,
                formatter: function() {
                  const sales = '$' + Highcharts.numberFormat(this.y, 0, '.', ',');
                  const items_sold = this.point.custom?.items_sold || 0;
                  const project_hours = this.point.custom?.project_hours || 0;
                  const sales_hours = this.point.custom?.sales_hours || 0;
                  const avg = this.point.custom?.avg || 0;
                  
                  let labelString = `<div style="text-align: center;">
                      <div>${sales}</div>
                      <div style="font-size: 12px; color: #777;">
                        ${items_sold.toLocaleString()} sale${items_sold === 1 ? '' : 's'}
                      </div>
                    </div>`;
                  
                  if(avg > 0){
                    labelString = `<div style="text-align: center;">
                      <div>${sales}</div>
                      <div style="font-size: 12px; color: #777;">
                        ${items_sold.toLocaleString()} sale${items_sold === 1 ? '' : 's'}
                      </div>
                      <div style="font-size: 12px; color: #007bff;">
                        $${avg.toFixed(2)}/hr
                      </div>
                    </div>`;
                  }

                  return labelString;
                },
                style: {
                  color: '#333',
                  fontSize: '14px'
                }
              }
						}
					},
					series: [{
						name: 'Total Sales',
						data: data,
						color: '#193856'
					}],
          credits: {
            enabled: false
          }
				});

        $('#export-total-sales-chart').off('click').on('click', async () => {
          const startDate = "<%= @start_date.strftime('%m/%d/%Y') %>";
          const endDate = "<%= @end_date.strftime('%m/%d/%Y') %>";

          // --- Sort by total amount sold (descending)
          const sortedBySales = Object.values(totalsByPerson)
            .sort((a, b) => b.totals.amountSold - a.totals.amountSold);

          // --- Sort by avgPerHour (descending)
          const sortedByAvg = Object.values(totalsByPerson)
            .sort((a, b) => b.avgPerHour - a.avgPerHour);

          // --- Build workbook
          const wb = new ExcelJS.Workbook();
          const ws = wb.addWorksheet('Total Sales');

          // --- Title (row 1)
          ws.mergeCells('A1:H1');
          const titleCell = ws.getCell('A1');
          titleCell.value = startDate === endDate
            ? `Sales for ${startDate}`
            : `Sales from ${startDate} to ${endDate}`;
          titleCell.font = { bold: true, size: 14 };
          titleCell.alignment = { horizontal: 'center', vertical: 'middle' };

          let fileName = startDate === endDate
            ? `Sales-Report-for-${startDate.replace(/\//g, '-')}.xlsx`
            : `Sales-Report-from-${startDate.replace(/\//g, '-')}-to-${endDate.replace(/\//g, '-')}.xlsx`;

          // --- Row 2: Total amount
          ws.mergeCells('A2:H2');
          const totalAmountCell = ws.getCell('A2');
          totalAmountCell.value = Number(grandTotals.amountSold);
          totalAmountCell.numFmt = '"Total Amount Sold: $"#,##0';
          totalAmountCell.font = { size: 12 };
          totalAmountCell.alignment = { horizontal: 'center', vertical: 'middle' };

          // --- Row 3: Total sales floor hours
          ws.mergeCells('A3:H3');
          const totalSalesFloorHoursCell = ws.getCell('A3');
          totalSalesFloorHoursCell.value = `Total Sales Floor Hours: ${grandTotals.salesFloorHours}`;
          totalSalesFloorHoursCell.font = { size: 12 };
          totalSalesFloorHoursCell.alignment = { horizontal: 'center', vertical: 'middle' };
          
          // --- Row 4: Average Per Hour
          ws.mergeCells('A4:H4');
          const avgCell = ws.getCell('A4');
          avgCell.value = Number(grandTotals.avgPerHour);
          avgCell.numFmt = '"Average Per Hour: $"#,##0.00""';
          avgCell.font = { size: 12 };
          avgCell.alignment = { horizontal: 'center', vertical: 'middle' };

          // --- Row 5: Total items
          ws.mergeCells('A5:H5');
          const totalItemsCell = ws.getCell('A5');
          totalItemsCell.value = `Total Items Sold: ${grandTotals.itemsSold.toLocaleString()}`;
          totalItemsCell.font = { size: 12 };
          totalItemsCell.alignment = { horizontal: 'center', vertical: 'middle' };

          // --- Spacer (row 6)
          ws.addRow([]);

          // --- Header (row 7)
          const headerRow = ws.addRow([
            'Name',
            'Items Sold',
            'Amount Sold',
            'Sales Floor Hours',
            'Project Hours',
            'Rank',
            'Average Per Hour',
            'Name'
          ]);
          headerRow.font = { bold: true };
          headerRow.alignment = { horizontal: 'center', vertical: 'middle' };
          // color+bold the Rank header (column F)
          headerRow.getCell(6).font = { bold: true, color: { argb: 'FFA8504B' } };

          // --- Data rows Aâ€“F: sorted by sales (start at row 8)
          let rank = 1;
          sortedBySales.forEach(personData => {
            const { name, totals } = personData;
            const row = ws.addRow([
              name,
              totals.itemsSold,
              totals.amountSold,
              totals.salesFloorHours,
              totals.projectHours,
              rank,
              null,
              null
            ]);

            // Format B as currency
            row.getCell(3).numFmt = '"$"#,##0;[Red]-"$"#,##0';

            // style Rank cell (F)
            row.getCell(6).font = { bold: true, color: { argb: 'FFA8504B' } };
            row.alignment = { horizontal: 'center', vertical: 'middle' };

            rank++;
          });

          // --- Fill columns G (Average) and H (Sales Person by Avg)
          // Data rows start at row 8
          sortedByAvg.forEach((p, i) => {
            const rowIndex = i + 8;
            const avgVal = p.avgPerHour || 0;
            ws.getCell(rowIndex, 7).numFmt = '"$"#,##0.00""';
            ws.getCell(rowIndex, 7).value = avgVal;
            ws.getCell(rowIndex, 8).value = p.name;            

            // style avg/name cells alignment
            ws.getCell(rowIndex, 7).alignment = { horizontal: 'center', vertical: 'middle' };
            ws.getCell(rowIndex, 8).alignment = { horizontal: 'center', vertical: 'middle' };
          });

          // After filling sortedBySales & sortedByAvg
          salesPeopleWithoutSales.sort((a, b) => {
            const nameA = `${a.first_name} ${a.last_name}`.toLowerCase();
            const nameB = `${b.first_name} ${b.last_name}`.toLowerCase();
            if (nameA < nameB) return -1;
            if (nameA > nameB) return 1;
            return 0;
          });
          
          salesPeopleWithoutSales.forEach(person => {
            const row = ws.addRow([
              `${person.first_name} ${person.last_name}`,
              '---',
              '---',
              '---',
              '---',
              rank,
              '---',
              `${person.first_name} ${person.last_name}`
            ]);

            // Center align all cells
            [1,2,3,4,5,6,7,8].forEach(c => {
              row.getCell(c).alignment = { horizontal: 'center', vertical: 'middle' };
            });

            // Style Rank cell (F)
            row.getCell(6).font = { bold: true, color: { argb: 'FFA8504B' } };

            rank++; // increment rank for next row
          });

          // --- Column widths
          const widths = [25, 25, 25, 25, 25, 10, 25, 25];
          widths.forEach((w, i) => (ws.getColumn(i + 1).width = w));

          // --- Export
          const buf = await wb.xlsx.writeBuffer();
          saveAs(new Blob([buf], { type: 'application/octet-stream' }), fileName);
        });

      }
      
      populateSalesPersonSelect();
      populateSellDateSelect();

      $('#sales-person-filter').on('changed.bs.select', processSalesRecords);
      $('#sell-date-filter').on('changed.bs.select', processSalesRecords);  
      
      processSalesRecords();  
    });
  </script>
<% end %>