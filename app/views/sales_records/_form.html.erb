<%= form_with(model: sales_record, local: true, id: "sales_record_form") do |form| %>
  <div class="row g-3 mb-3 align-items-center">
    <div class="col-12">
      <label class="col-form-label"><strong>Sales Person</strong></label>
      <select id="sales_person" class="form-control select2">
        <%= options_from_collection_for_select(
          SalesPerson.order(:first_name, :last_name),
          :id,
          ->(sp) { "#{sp.first_name} #{sp.last_name}" },
          sales_record.sales_person_id
        ) %>
      </select>
    </div>
  </div>

  <%= form.hidden_field :sales_person_id, id:"hidden_sales_person" %>
  <%= form.hidden_field :sell_date, id:"hidden_sell_date" %>

  <div class="row g-3 mb-3 align-items-center">
    <div class="col-12">
      <label class="col-form-label"><strong>Sell Date</strong></label>
      <div class="input-group">
        <input type="text" id="sell_date" class="form-control datepicker"
       value="<%= (@sales_record.sell_date || Date.today).strftime('%m/%d/%Y') %>" />
        <span class="input-group-text datepicker-icon">
          <i class="bi bi-calendar3"></i>
        </span>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-3 align-items-center">
    <div class="col-12">
      <label class="col-form-label"><strong>Amount Sold</strong></label>
      <%= form.number_field :amount_sold, step: 1, class: "form-control", id:"amount_sold" %>
    </div>
  </div>

  <div class="row g-3 mb-3 align-items-center">
    <div class="col-6">
      <label class="col-form-label"><strong>Sales Floor Hours</strong></label>
      <%= form.number_field :sales_floor_hours, step: :any, class: "form-control", id:"sales_floor_hours" %>
    </div>
    <div class="col-6">
      <label class="col-form-label"><strong>Project Hours</strong></label>
      <%= form.number_field :project_hours, placeholder: 0, step: :any, class: "form-control", id:"project_hours" %>
    </div>
  </div>
  
  <div class="row" id="submit_btn_row" style="display: none;">
    <div class="col-12 d-flex justify-content-end">
      <%= submit_tag 'Submit', class: 'btn btn-main', id: 'submit_button', onclick:"show_spinner()", data: { turbo: false } %>
    </div>
  </div>
<% end %>

<script>
  $(document).ready(function() {
    const salesPerson       = document.getElementById("sales_person");
    const hiddenSalesPerson = document.getElementById("hidden_sales_person");
    const sellDate          = document.getElementById("sell_date");
    const hiddenSellDate    = document.getElementById("hidden_sell_date");
    const amountSold        = document.getElementById("amount_sold");
    const salesFloorHours   = document.getElementById("sales_floor_hours");
    const projectHours      = document.getElementById("project_hours");
    const submitRow         = document.getElementById("submit_btn_row");
    const form              = document.getElementById("sales_record_form");

    // keep hidden fields in sync
    $('#sales_person').on('change', function() {
      hiddenSalesPerson.value = this.value;
      checkAllFieldsFilled();
    });

    $('#sell_date').on('change input', function() {
      hiddenSellDate.value = this.value;
      checkAllFieldsFilled();
    });

    function checkAllFieldsFilled() {
      const amount = parseFloat(amountSold.value) || 0;
      const sales_floor_hours = parseFloat(salesFloorHours.value) || 0;
      const project_hours  = parseFloat(projectHours.value) || 0;
      const amountSoldValid = amount >= 0;
      const salesFloorHoursValid = sales_floor_hours >= 0;
      const projectHoursValid = project_hours >= 0;

      const requiredFieldsFilled = salesPerson.value && sellDate.value && amountSoldValid && salesFloorHoursValid && projectHoursValid;

      const inconsistentAmounts = (amount === 0 && sales_floor_hours === 0 && project_hours === 0) || (amount > 0 && sales_floor_hours === 0)

      const showSubmit = requiredFieldsFilled && !inconsistentAmounts;

      submitRow.style.display = showSubmit ? "flex" : "none";
    }

    [amountSold, salesFloorHours, projectHours].forEach(el => {
      el.addEventListener("change", checkAllFieldsFilled);
      el.addEventListener("input", checkAllFieldsFilled);
    });

    form.addEventListener("submit", function() {
      hiddenSalesPerson.value = salesPerson.value;
      hiddenSellDate.value = sellDate.value;
    });

    hiddenSalesPerson.value = salesPerson.value;
    hiddenSellDate.value = sellDate.value;
    checkAllFieldsFilled();
  });
</script>